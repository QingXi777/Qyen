<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Qyen Vision</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<style>
:root{
  --bg:#0b0f14; --pane:#1e2329; --pane-2:#252a31; --line:#2a3038;
  --tx-1:#e7ebf0; --tx-2:#c9d1d9; --brand:#60a5fa;
  --btn:#ffffff; --btn-tx:#111;
  --scroll:#5a5f66; --scroll-hover:#9aa1a8;
}
.light{
  --bg:#f6f7fb; --pane:#ffffff; --pane-2:#f3f4f6; --line:#e5e7eb;
  --tx-1:#111827; --tx-2:#374151; --brand:#2563eb;
  --btn:#111827; --btn-tx:#fff;
  --scroll:#c3c7cd; --scroll-hover:#a9afb6;
}
body{background:var(--bg);color:var(--tx-1);font-family:system-ui,sans-serif;}
/* 输入区 */
.gpt-bar{background:var(--pane-2);border:1px solid rgba(0,0,0,0.15);border-radius:24px;display:flex;flex-direction:column;padding:6px 10px;}
.light .gpt-bar{border-color:var(--line);}
.inner-row{display:flex;align-items:center;gap:8px;width:100%;}
.btn-circle{width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center;transition:filter .15s ease,transform .1s ease;flex-shrink:0;}
.btn-plus{background:rgba(255,255,255,.07);}
.light .btn-plus{background:#eef0f4;}
.btn-send{background:var(--btn);color:var(--btn-tx);box-shadow:0 2px 10px rgba(0,0,0,.2);}
.btn-send:hover{filter:brightness(1.03);}
.btn-send:active{transform:translateY(1px);}
.input-wrap{flex:1;max-height:280px;overflow-y:auto;display:flex;align-items:center;background:transparent;scrollbar-width:thin;scrollbar-color:var(--scroll) transparent;}
.input-wrap::-webkit-scrollbar{width:6px;}
.input-wrap::-webkit-scrollbar-thumb{background-color:var(--scroll);border-radius:3px;}
textarea{width:100%;flex:1;resize:none;border:none;outline:none;background:transparent;color:var(--tx-1);font-size:15px;line-height:1.4;padding:10px 0 6px;vertical-align:middle;}
textarea::placeholder{color:var(--tx-2);opacity:.85;}
/* 预览缩略图 */
.preview-inline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
.thumb{position:relative;width:72px;height:72px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#111;cursor:pointer;}
.light .thumb{background:#f2f3f5;}
.thumb img{width:100%;height:100%;object-fit:cover;}
.thumb .x{position:absolute;top:6px;right:6px;width:20px;height:20px;border-radius:9999px;background:rgba(0,0,0,.6);color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;}
/* 对话气泡 */
.chat-bubble{display:flex;gap:10px;align-items:flex-start;}
.chat-bubble.user{justify-content:flex-end;}
.chat-bubble.ai{justify-content:flex-start;}
.avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;}
.avatar.user{background:var(--brand);color:#fff;}
.avatar.ai{background:var(--pane-2);color:var(--tx-1);}
.bubble-content{max-width:70%;padding:10px 14px;border-radius:14px;word-break:break-word;}
.bubble-content.user{background:var(--brand);color:#fff;border-bottom-right-radius:4px;}
.bubble-content.ai{background:var(--pane);color:var(--tx-1);border-bottom-left-radius:4px;}
/* 限制气泡内图片大小 + 美化 */
.bubble-content img{
  display:block;
  max-width:320px;
  max-height:240px;
  width:auto;height:auto;
  margin:6px auto 0;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);
  cursor:pointer;
}
.bubble-content{opacity:0;transform:translateY(10px);animation:fadeIn .25s ease forwards;}
@keyframes fadeIn{to{opacity:1;transform:none;}}

/* 液体加载条（20px） */
.liquid-loader{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px 4px;}
.loader-track{position:relative;width:180px;height:20px;background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border-radius:10px;overflow:hidden;box-shadow:inset 0 2px 3px rgba(0,0,0,.6),0 1px 3px rgba(255,255,255,.1);}
.liquid-fill{position:absolute;top:1px;left:1px;height:calc(100% - 2px);background:linear-gradient(90deg,#4f46e5,#7c3aed,#ec4899,#f59e0b);border-radius:8px;animation:fillProgress 4s ease-out infinite,colorShift 3s linear infinite;box-shadow:0 0 10px rgba(124,58,237,.35),inset 0 1px 2px rgba(255,255,255,.2);}
.loading-text{color:var(--tx-1);font-size:14px;font-weight:600;letter-spacing:.5px;}
.loading-text .dot{margin-left:2px;animation:blink 1.5s infinite;}
.loading-text .dot:nth-of-type(2){animation-delay:.3s;}
.loading-text .dot:nth-of-type(3){animation-delay:.6s;}
@keyframes fillProgress{0%{width:4px;}25%{width:25%;}50%{width:50%;}75%{width:75%;}100%{width:calc(100% - 2px);}}
@keyframes colorShift{0%{filter:hue-rotate(0deg) brightness(1);}33%{filter:hue-rotate(120deg) brightness(1.1);}66%{filter:hue-rotate(240deg) brightness(0.9);}100%{filter:hue-rotate(360deg) brightness(1);}}
@keyframes blink{0%,50%{opacity:1;}51%,100%{opacity:0;}}
/* 预览大图 */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:50;}
.modal.open{display:flex;}
.modal img{max-width:92vw;max-height:92vh;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.5);}
</style>
</head>
<body class="h-full">
<body class="h-full">
<script>
  if (!localStorage.getItem('isLoggedIn')) {
    window.location.replace('index.html'); // 未登录直接回登录页
  }
</script>

<header class="sticky top-0 z-20 bg-[color:var(--bg)]/80 backdrop-blur border-b border-[color:var(--line)]">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="text-base font-semibold tracking-wide">Qyen Vision</h1>
    <div class="flex items-center">
      <button id="themeToggle" class="rounded-full w-9 h-9 border border-[color:var(--line)] flex items-center justify-center">
        <i id="themeIcon" data-lucide="sun"></i>
      </button>
      <!-- 新增：退出登录按钮（紧挨主题切换，右侧） -->
      <button id="logoutBtn" class="rounded-full w-9 h-9 border border-[color:var(--line)] flex items-center justify-center ml-2" title="退出登录">
        <i data-lucide="log-out"></i>
      </button>
    </div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 pt-6 pb-40">
  <div id="chatList" class="space-y-6"></div>
</main>

<div class="fixed bottom-4 inset-x-0">
  <div class="max-w-3xl mx-auto px-4">
    <div class="gpt-bar">
      <div id="preview" class="hidden preview-inline"></div>
      <div class="inner-row">
        <button id="uploadBtn" class="btn-circle btn-plus" title="上传图片"><i data-lucide="plus"></i></button>
        <input id="file" type="file" accept="image/*" class="hidden" multiple>
        <div class="input-wrap">
          <textarea id="prompt" rows="1" placeholder="和 Q 对话，或描述你要生成的图片…"></textarea>
        </div>
        <button id="sendChat" class="btn-circle btn-send" title="发送文字"><i data-lucide="send"></i></button>
        <button id="sendImage" class="btn-circle btn-send" title="生成图片"><i data-lucide="image"></i></button>
      </div>
    </div>
  </div>
</div>

<div id="imgModal" class="modal"><img id="modalImg" src="" alt="预览"/></div>

<script>
lucide.createIcons();
const WEBHOOK_URL='https://n8n-kjycwasd.us-east-1.clawcloudrun.com/webhook-test/Qyen-image';
const qs=s=>document.querySelector(s);
const chatList=qs('#chatList'),promptEl=qs('#prompt'),fileEl=qs('#file'),
uploadBtn=qs('#uploadBtn'),sendChatBtn=qs('#sendChat'),sendImageBtn=qs('#sendImage'),
previewEl=qs('#preview'),themeBtn=qs('#themeToggle'),themeIcon=qs('#themeIcon'),
imgModal=qs('#imgModal'),modalImg=qs('#modalImg');
const MAX_HEIGHT=280;let filesBuffer=[];

/* 主题切换 */
function applyTheme(t){document.documentElement.classList.toggle('light',t==='light');themeIcon.setAttribute('data-lucide',t==='light'?'moon':'sun');lucide.createIcons();localStorage.setItem('qv-theme',t);}
(function(){const s=localStorage.getItem('qv-theme');const p=window.matchMedia('(prefers-color-scheme: light)').matches;applyTheme(s||(p?'light':'dark'));})();
themeBtn.onclick=()=>applyTheme(document.documentElement.classList.contains('light')?'dark':'light');

/* ========= 新增：退出登录 ========= */
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.onclick = () => {
    try { localStorage.removeItem('isLoggedIn'); } catch(e) {}
    window.location.href = 'index.html';
  };
}
/* ========= 新增结束 ========= */

/* 输入自适应 */
promptEl.oninput=()=>{promptEl.style.height='auto';promptEl.style.height=Math.min(promptEl.scrollHeight,MAX_HEIGHT)+'px';};
promptEl.onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send('chat');}};

/* 上传预览（thumb 用 blob:，可安全 revoke） */
uploadBtn.onclick=()=>fileEl.click();
fileEl.onchange=()=>{for(const f of fileEl.files){filesBuffer.push({file:f,url:URL.createObjectURL(f)});}fileEl.value='';refreshPreview();};
function refreshPreview(){
  previewEl.innerHTML='';
  if(!filesBuffer.length){previewEl.classList.add('hidden');return;}
  previewEl.classList.remove('hidden');
  for(let [i,it] of filesBuffer.entries()){
    const d=document.createElement('div');
    d.className='thumb';
    d.innerHTML=`<img src="${it.url}" alt=""><button class='x' title="移除">✕</button>`;
    d.addEventListener('click',ev=>{if(ev.target.classList.contains('x'))return;openModal(it.url);});
    d.querySelector('.x').onclick=e=>{e.stopPropagation();URL.revokeObjectURL(it.url);filesBuffer.splice(i,1);refreshPreview();};
    previewEl.appendChild(d);
  }
  if(previewEl._sortable){previewEl._sortable.destroy();}
  previewEl._sortable=Sortable.create(previewEl,{animation:150,onEnd:({oldIndex,newIndex})=>{
    const m=filesBuffer.splice(oldIndex,1)[0];filesBuffer.splice(newIndex,0,m);refreshPreview();
  }});
}

/* 模态放大 */
function openModal(src){modalImg.src=src;imgModal.classList.add('open');}
function closeModal(){imgModal.classList.remove('open');modalImg.src='';}
imgModal.addEventListener('click',e=>{if(e.target===imgModal)closeModal();});
window.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

/* 工具：File -> DataURL（用于气泡持久显示） */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(fr.result);
    fr.onerror=reject;
    fr.readAsDataURL(file);
  });
}

/* 对话气泡 */
function appendBubble(role,htmlOrText,{isHTML=false,isImage=false}={}){
  const wrap=document.createElement('div');wrap.className='chat-bubble '+role;
  const avatar=document.createElement('div');avatar.className='avatar '+role;avatar.textContent=role==='user'?'U':'Q';
  const bubble=document.createElement('div');bubble.className='bubble-content '+role;
  if(isHTML) bubble.innerHTML=htmlOrText;
  else if(isImage) bubble.innerHTML=`<img src="${htmlOrText}" alt="">`;
  else bubble.innerHTML=String(htmlOrText).replace(/\n/g,'<br>');
  if(role==='user'){wrap.appendChild(bubble);wrap.appendChild(avatar);}else{wrap.appendChild(avatar);wrap.appendChild(bubble);}
  chatList.appendChild(wrap);
  bubble.addEventListener('click',ev=>{const img=ev.target.closest('img');if(img)openModal(img.src);});
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  return bubble;
}
function loaderHTML(){
  return `<div class="liquid-loader"><div class="loader-track"><div class="liquid-fill"></div></div><div class="loading-text">Qyen正在生成<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div></div>`;
}
/* 打字机（更快：15ms/字） */
function typeWriter(el,text,speed=15){el.innerHTML='';let i=0;const timer=setInterval(()=>{el.innerHTML+=text[i]==='\n' ? '<br>' : text[i];window.scrollTo({top:document.body.scrollHeight});i++;if(i>=text.length)clearInterval(timer);},speed);}

sendChatBtn.onclick=()=>send('chat');
sendImageBtn.onclick=()=>send('image');

async function send(type){
  const text=promptEl.value.trim();
  if(!text && !filesBuffer.length) return;

  /* 用户气泡：文字 + 图片(DataURL 持久) */
  let userHTML='';
  if(text){ userHTML+=`<div>${text.replace(/\n/g,'<br>')}</div>`; }
  if(filesBuffer.length){
    const dataUrls = await Promise.all(filesBuffer.map(({file})=>fileToDataURL(file)));
    userHTML += dataUrls.map(u=>`<img src="${u}" alt="">`).join('');
  }
  const userBubble=appendBubble('user',userHTML,{isHTML:true});
  userBubble.querySelectorAll('img').forEach(img=>img.onclick=()=>openModal(img.src));

  /* Q 加载条 */
  const aiBubble=appendBubble('ai',loaderHTML(),{isHTML:true});

  /* 请求体 */
  const fd=new FormData();
  if(text) fd.append('prompt',text);
  if(filesBuffer.length){ for(const {file} of filesBuffer){ fd.append('image',file); } }
  fd.append('action', type==='image' ? 'edit' : 'reverse');

  try{
    const res=await fetch(WEBHOOK_URL,{method:'POST',body:fd});
    const ctype=(res.headers.get('Content-Type')||'').toLowerCase();
    if(!res.ok) throw new Error(await res.text().catch(()=>('HTTP '+res.status)));
    if(ctype.includes('image/')){
      const blob=await res.blob(); const url=URL.createObjectURL(blob);
      aiBubble.innerHTML=`<img src="${url}" alt="生成结果">`;
    }else{
      const txt=await res.text();
      aiBubble.innerHTML=''; typeWriter(aiBubble,txt,15);
    }
  }catch(err){
    aiBubble.textContent='❌ 出错了：'+(err?.message||err);
  }finally{
    /* 只清理预览用的 blob:，不影响气泡中的 DataURL */
    promptEl.value=''; promptEl.style.height='40px';
    filesBuffer.forEach(it=>URL.revokeObjectURL(it.url));
    filesBuffer=[]; previewEl.innerHTML=''; previewEl.classList.add('hidden');
  }
}
</script>
</body>
</html>
